generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  DONOR
  FUND_RAISER
  ADMIN
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
}

enum DonationStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  PAST_DUE
}

enum OrgMemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum NotificationType {
  DONATION
  CAMPAIGN
  SYSTEM
  TEAM
}

model User {
  id                  String               @id @default(uuid(7))
  name                String
  email               String               @unique
  password            String
  role                UserRole             @default(DONOR)
  verificationStatus  Boolean              @default(false) @map("verification_status")
  verificationToken   String?              @map("verification_token")
  resetToken          String?              @map("reset_token")
  resetTokenExpiry    DateTime?            @map("reset_token_expiry")
  onboardingCompleted Boolean              @default(false) @map("onboarding_completed")
  onboardingStep      Int                  @default(0) @map("onboarding_step")
  createdAt           DateTime             @default(now()) @map("created_at")
  campaigns           Campaign[]
  donations           Donation[]
  paymentProviders    PaymentProvider[]
  paymentLogs         PaymentLog[]
  subscription        Subscription?
  ownedOrganizations  Organization[]       @relation("OrganizationOwner")
  organizationMembers OrganizationMember[]
  notifications       Notification[]

  @@map("users")
}

model Campaign {
  id             String         @id @default(uuid(7))
  title          String
  description    String?
  type           String
  goalAmount     Decimal        @map("goal_amount")
  raisedAmount   Decimal        @map("raised_amount")
  startDate      DateTime       @map("start_date")
  endDate        DateTime       @map("end_date")
  status         CampaignStatus @default(DRAFT)
  category       String
  organizationId String?        @map("organization_id")
  createdAt      DateTime       @default(now()) @map("created_at")

  user         User          @relation(fields: [fundraiserId], references: [id])
  fundraiserId String        @map("fundraiser_id")
  organization Organization? @relation(fields: [organizationId], references: [id])
  donations    Donation[]

  @@map("campaigns")
}

model Donation {
  id         String  @id @default(uuid())
  campaignId String  @map("campaign_id")
  donorId    String? @map("donor_id")

  amount        Decimal
  status        DonationStatus @default(PENDING)
  isAnonymous   Boolean        @default(false)
  provider      String
  transactionId String?        @unique @map("transaction_id")
  createdAt     DateTime       @default(now()) @map("created_at")

  campaign Campaign @relation(fields: [campaignId], references: [id])
  donor    User?    @relation(fields: [donorId], references: [id])

  @@index([campaignId])
  @@index([donorId])
  @@map("donations")
}

model PaymentProvider {
  id        String   @id @default(uuid())
  name      String
  currency  String   @default("BDT")
  isActive  Boolean  @default(true) @map("is_active")
  isDefault Boolean  @default(false) @map("is_default")
  config    Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  fundRaiser   User   @relation(fields: [fundRaiserId], references: [id])
  fundRaiserId String @map("fund_raiser_id")

  @@unique([id, fundRaiserId])
  @@map("payment_providers")
}

model PaymentLog {
  id                    String  @id @default(uuid())
  transactionId         String  @unique @map("transaction_id")
  valId                 String  @unique @map("val_id")
  amount                Decimal
  storeAmount           Decimal @map("store_amount")
  currency              String
  bankTranId            String  @map("bank_tran_id")
  cardType              String  @map("card_type")
  cardNo                String  @map("card_no")
  cardIssuer            String  @map("card_issuer")
  cardBrand             String  @map("card_brand")
  cardIssuerCountry     String  @map("card_issuer_country")
  cardIssuerCountryCode String  @map("card_issuer_country_code")
  currencyType          String  @map("currency_type")
  currencyAmount        Decimal @map("currency_amount")
  currencyRate          Decimal @map("currency_rate")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  fundRaiser   User   @relation(fields: [fundRaiserId], references: [id])
  fundRaiserId String @map("fund_raiser_id")

  @@map("payment_logs")
}

model Plan {
  id            String         @id @default(uuid())
  name          String
  type          PlanType       @unique
  price         Decimal
  interval      String         @default("month")
  features      Json
  limits        Json
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @unique @map("user_id")
  planId               String             @map("plan_id")
  status               SubscriptionStatus @default(ACTIVE)
  stripeSubscriptionId String?            @unique @map("stripe_subscription_id")
  stripeCustomerId     String?            @map("stripe_customer_id")
  currentPeriodStart   DateTime           @map("current_period_start")
  currentPeriodEnd     DateTime           @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])
  plan Plan @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

model Organization {
  id             String   @id @default(uuid())
  name           String
  slug           String   @unique
  ownerId        String   @map("owner_id")
  settings       Json?
  logoUrl        String?  @map("logo_url")
  primaryColor   String?  @default("#667eea") @map("primary_color")
  secondaryColor String?  @default("#764ba2") @map("secondary_color")
  customDomain   String?  @unique @map("custom_domain")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  owner     User                 @relation("OrganizationOwner", fields: [ownerId], references: [id])
  members   OrganizationMember[]
  campaigns Campaign[]

  @@index([customDomain])
  @@map("organizations")
}

model OrganizationMember {
  id             String        @id @default(uuid())
  organizationId String        @map("organization_id")
  userId         String        @map("user_id")
  role           OrgMemberRole @default(MEMBER)
  joinedAt       DateTime      @default(now()) @map("joined_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@map("notifications")
}
