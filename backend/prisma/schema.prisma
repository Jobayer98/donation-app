generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  DONOR
  FUND_RAISER
  ADMIN
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CLOSED
}

enum DonationStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum PlanInterval {
  MONTH
  YEAR
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  PAST_DUE
}

enum NotificationType {
  DONATION
  CAMPAIGN
  SYSTEM
  TEAM
}

model User {
  id                  String    @id @default(uuid(7))
  name                String
  email               String    @unique
  password            String
  role                UserRole  @default(DONOR)
  verificationStatus  Boolean   @default(false) @map("verification_status")
  verificationToken   String?   @map("verification_token")
  resetToken          String?   @map("reset_token")
  resetTokenExpiry    DateTime? @map("reset_token_expiry")
  onboardingCompleted Boolean   @default(false) @map("onboarding_completed")
  onboardingStep      Int       @default(0) @map("onboarding_step")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  donations     Donation[]
  notifications Notification[]
  organizations Organization[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Campaign {
  id             String         @id @default(uuid(7))
  title          String
  description    String?
  imageUrl       String?        @map("image_url")
  type           String
  goalAmount     Decimal        @map("goal_amount") @db.Decimal(12, 2)
  raisedAmount   Decimal        @default(0) @map("raised_amount") @db.Decimal(12, 2)
  startDate      DateTime       @map("start_date")
  endDate        DateTime       @map("end_date")
  status         CampaignStatus @default(DRAFT)
  category       String
  organizationId String         @map("organization_id")
  createdById    String         @map("created_by_id")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  donations    Donation[]

  @@index([organizationId])
  @@index([status])
  @@index([organizationId, status])
  @@index([createdAt])
  @@map("campaigns")
}

model Donation {
  id         String  @id @default(uuid(7))
  campaignId String  @map("campaign_id")
  donorId    String? @map("donor_id")

  amount        Decimal        @db.Decimal(12, 2)
  status        DonationStatus @default(PENDING)
  isAnonymous   Boolean        @default(false) @map("is_anonymous")
  provider      String
  transactionId String?        @unique @map("transaction_id")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  donor    User?    @relation(fields: [donorId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([donorId])
  @@index([status])
  @@index([createdAt])
  @@index([campaignId, status])
  @@map("donations")
}

model PaymentProvider {
  id             String   @id @default(uuid(7))
  name           String
  currency       String   @default("BDT")
  isActive       Boolean  @default(true) @map("is_active")
  isDefault      Boolean  @default(false) @map("is_default")
  config         Json
  organizationId String   @map("organization_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, isActive])
  @@map("payment_providers")
}

model PaymentLog {
  id                    String   @id @default(uuid(7))
  transactionId         String   @unique @map("transaction_id")
  valId                 String   @unique @map("val_id")
  amount                Decimal  @db.Decimal(12, 2)
  storeAmount           Decimal  @map("store_amount") @db.Decimal(12, 2)
  currency              String
  bankTranId            String   @map("bank_tran_id")
  cardType              String   @map("card_type")
  cardNo                String   @map("card_no")
  cardIssuer            String   @map("card_issuer")
  cardBrand             String   @map("card_brand")
  cardIssuerCountry     String   @map("card_issuer_country")
  cardIssuerCountryCode String   @map("card_issuer_country_code")
  currencyType          String   @map("currency_type")
  currencyAmount        Decimal  @map("currency_amount") @db.Decimal(12, 2)
  currencyRate          Decimal  @map("currency_rate") @db.Decimal(10, 4)
  organizationId        String   @map("organization_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([transactionId])
  @@map("payment_logs")
}

model Plan {
  id            String         @id @default(uuid(7))
  name          String
  type          PlanType       @unique
  price         Decimal        @db.Decimal(10, 2)
  interval      String
  features      Json
  limits        Json
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  subscriptions Subscription[]

  @@index([isActive])
  @@map("plans")
}

model Subscription {
  id                   String             @id @default(uuid(7))
  organizationId       String             @unique @map("organization_id")
  planId               String             @map("plan_id")
  status               SubscriptionStatus @default(ACTIVE)
  stripeSubscriptionId String?            @unique @map("stripe_subscription_id")
  stripeCustomerId     String?            @map("stripe_customer_id")
  currentPeriodStart   DateTime           @map("current_period_start")
  currentPeriodEnd     DateTime           @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan         Plan         @relation(fields: [planId], references: [id])

  @@index([status])
  @@index([planId])
  @@map("subscriptions")
}

model Organization {
  id                 String   @id @default(uuid(7))
  name               String
  slug               String   @unique
  ownerId            String   @map("owner_id")
  settings           Json?
  logoUrl            String?  @map("logo_url")
  website            String?
  email              String?
  phone              String?
  description        String?
  donationAlert      Boolean  @default(true) @map("donation_alert")
  donationAlertEmail Boolean  @default(true) @map("donation_alert_email")
  weeklySummary      Boolean  @default(true) @map("weekly_summary")
  monthlySummary     Boolean  @default(true) @map("monthly_summary")
  primaryColor       String   @default("#667eea") @map("primary_color")
  secondaryColor     String   @default("#764ba2") @map("secondary_color")
  customDomain       String?  @unique @map("custom_domain")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  owner            User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  campaigns        Campaign[]
  paymentProviders PaymentProvider[]
  paymentLogs      PaymentLog[]
  subscription     Subscription?

  @@index([ownerId])
  @@index([slug])
  @@index([customDomain])
  @@index([isActive])
  @@map("organizations")
}

model Notification {
  id        String           @id @default(uuid(7))
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}
